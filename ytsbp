#VARS
SCRIPTPATH=$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )
THEME=default
USE_BACKGROUND=dark # possible values - no, dark, color, all
echo 'GETTING XML';
 
#PREP FILE
rm $SCRIPTPATH/index.html
touch $SCRIPTPATH/index.html

#OPEN BODY
echo "<!DOCTYPE html><html id='html'><head><title>☛ ☈☉☊☌☡ ☚</title><link rel='shortcut icon' href='favicon.ico'><link type='text/css' rel='stylesheet' href='themes/$THEME.css'><link type='text/css' rel='stylesheet' href='themes/patterns.css'><script type='text/javascript' src='https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js'></script>
</head><body id='body' class='$USE_BACKGROUND" >> $SCRIPTPATH/index.html


RAND=$((1 + RANDOM % 40));
if [ $RAND -eq 1 ]; then echo 'one'; elif [ $RAND -eq 2 ]; then echo 'two'; elif [ $RAND -eq 3 ]; then echo 'three';elif [ $RAND -eq 4 ]; then echo 'four';elif [ $RAND -eq 5 ]; then echo 'five';elif [ $RAND -eq 6 ]; then echo 'six';elif [ $RAND -eq 7 ]; then echo 'seven';elif [ $RAND -eq 8 ]; then echo 'eight';elif [ $RAND -eq 9 ]; then echo 'nine';elif [ $RAND -eq 10 ]; then echo 'ten';elif [ $RAND -eq 11 ]; then echo 'eleven';elif [ $RAND -eq 12 ]; then echo 'twelve';elif [ $RAND -eq 13 ]; then echo 'thirteen';elif [ $RAND -eq 14 ]; then echo 'fourteen';elif [ $RAND -eq 15 ]; then echo 'fifteen';elif [ $RAND -eq 16 ]; then echo 'sixteen';elif [ $RAND -eq 17 ]; then echo 'seventeen';elif [ $RAND -eq 18 ]; then echo 'eighteen';elif [ $RAND -eq 19 ]; then echo 'nineteen';elif [ $RAND -eq 20 ]; then echo 'twenty';elif [ $RAND -eq 21 ]; then echo 'ttone';elif [ $RAND -eq 22 ]; then echo 'tttwo'; elif [ $RAND -eq 27 ]; then echo 'ttseven';elif [ $RAND -eq 28 ]; then echo 'tteight';elif [ $RAND -eq 29 ]; then echo 'ttnine';elif [ $RAND -eq 30 ]; then echo 'thirty';elif [ $RAND -eq 31 ]; then echo 'tttone';elif [ $RAND -eq 32 ]; then echo 'ttttwo';elif [ $RAND -eq 33 ]; then echo 'tttthree';elif [ $RAND -eq 34 ]; then echo 'tttfour';elif [ $RAND -eq 35 ]; then echo 'tttfive';elif [ $RAND -eq 36 ]; then echo 'tttsix';elif [ $RAND -eq 37 ]; then echo 'tttseven';elif [ $RAND -eq 38 ]; then echo 'ttteight';elif [ $RAND -eq 39 ]; then echo 'tttnine';elif [ $RAND -eq 40 ]; then echo 'fourty'; else echo '$USE_BACKGROUND'; fi >> $SCRIPTPATH/index.html &&

echo "'>" >> $SCRIPTPATH/index.html

#LEFT NAV
echo "<nav><div class='back'></div><a href='index.html' class='icon logo'><span>⍾</span></a>" >> $SCRIPTPATH/index.html
echo "<div class='links'>" >> $SCRIPTPATH/index.html
	echo "<a href='#latest'><span>Latest</span></a>" >> $SCRIPTPATH/index.html
	cd $SCRIPTPATH/subs
		for d in `find * -type d`
		do
			echo "<a href='#$d'><span>$d</span></a>" >> $SCRIPTPATH/index.html
		done
	cd ..
echo "</div>" >> $SCRIPTPATH/index.html
echo "<div class='links'><p class='icon' id='input-toggle'><span><i class='search'>☌</i><input id='search-input' type='text' placeholder='Filter..' /></span></p></div>" >> $SCRIPTPATH/index.html
echo "</nav>" >> $SCRIPTPATH/index.html

#GET SUBSCRIPTIONS TO TMP FOLDER
rm -r $SCRIPTPATH/tmp
mkdir $SCRIPTPATH/tmp
cd $SCRIPTPATH/subs
for d in `find * -type d`
do
	cd $d
		for f in `find * -type f`
		do
			URL=$(cat $f);
			cd $SCRIPTPATH/tmp
			mkdir $d
			cd $d
			curl https://www.youtube.com/feeds/videos.xml?channel_id=$URL >> $f  
			cd $SCRIPTPATH/subs/$d
		done
	cd ..
done
cd $SCRIPTPATH

echo 'GENERATING HTML';

#GENERATE LATEST SPECIAL
cd $SCRIPTPATH/tmp
echo "<div class='category latest'><p class='section-title' id='latest'><span>Latest videos</span></p>" >> $SCRIPTPATH/index.html
echo "<section>" >> $SCRIPTPATH/index.html
for d in `find * -type d`
do
	cd $d
		for f in `find * -type f`
		do
			URL=$(cat $f);
			grep $f -e \<entry\> -e \<yt:videoId\> -e \<title\> -e media:thumbnail -e published	-e \</entry\>  >> $SCRIPTPATH/index.html
		done
	cd ..
done
echo "</section>" >> $SCRIPTPATH/index.html
echo "</div>" >> $SCRIPTPATH/index.html
cd $SCRIPTPATH


#GENERATE CATEGORY
cd $SCRIPTPATH/tmp
for d in `find * -type d`
do
	echo "<div class='category'><p class='section-title' id='$d'><span>$d</span></p>" >> $SCRIPTPATH/index.html
	cd $d
		for f in `find * -type f`
		do
			URL=$(cat $f);
			echo "<section>" >> $SCRIPTPATH/index.html
			grep $f -e \<entry\> -e \<yt:videoId\> -e \<title\> -e \<media:thumbnail -e \<published\>	-e \</entry\>  >> $SCRIPTPATH/index.html && 
			echo "</section>" >> $SCRIPTPATH/index.html
		done
	cd ..
	echo "</div>" >> $SCRIPTPATH/index.html
done
cd $SCRIPTPATH

#ADD EMPTY IFRAME
echo "<iframe id='iframe-popup' src='' frameborder='0' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe><a href='#' id='iframe-close'>✕</a>" >> $SCRIPTPATH/index.html
#CLOSE BODY
echo "</body>" >> $SCRIPTPATH/index.html
#INCLUDE JS
echo "<script src='themes/logic.js'></script>" >> $SCRIPTPATH/index.html
#CLOSE HTML
echo "</html>" >> $SCRIPTPATH/index.html

echo 'SANITIZING';
#CREATE LINK TO EMBED
find $SCRIPTPATH/index.html -exec sed -i 's/<yt:videoId>/<a class="iframe-source" href="https:\/\/www.youtube.com\/embed\//g' {} \;
find $SCRIPTPATH/index.html -exec sed -i 's/<\/yt:videoId>/?rel=0" ><\/a>/g' {} \;

#ITEM
find $SCRIPTPATH/index.html -exec sed -i 's/entry/item/g' {} \;

#DATE
find $SCRIPTPATH/index.html -exec sed -i 's/T.*<\/published/<\/published/g' {} \;
find $SCRIPTPATH/index.html -exec sed -i -e :1 -e 's@\(<published>.*\)-\(.*</published>\)@\1 \◦ \2@;t1' {} \;

#THUMB
find $SCRIPTPATH/index.html -exec sed -i 's/media:thumbnail url/img class="lozad" data-toggle-class="loaded" data-src/g' {} \;
echo 'DONE!';